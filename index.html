<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Portfolio Tracker</title>
  <meta name="description" content="Tracks ETH, BTC, USDT, DOGE, WRX, SHIB, SXP with Binance USD prices, WazirX INR prices, and USD→INR FX conversion.">
  <style>
    :root { color-scheme: light dark; --bg:#0b0c0f; --fg:#e8e9ee; --card:#151821; --muted:#98a2b3; --accent:#3b82f6; --border:#212635; --warn:#f59e0b; }
    * { box-sizing:border-box }
    body { margin:0; font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--fg); }
    header { padding:16px; border-bottom:1px solid var(--border); position:sticky; top:0; backdrop-filter:saturate(160%) blur(6px); background: color-mix(in oklab, var(--bg) 85%, transparent); }
    h1 { margin:0; font-size:18px; }
    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    button { background:#1b2030; color:var(--fg); border:1px solid var(--border); border-radius:8px; padding:8px 12px; font-size:14px; cursor:pointer; }
    button.primary { background: var(--accent); border-color: var(--accent); color:white; }
    .cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:12px; margin-top:12px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px 16px; }
    .row { display:flex; align-items:center; justify-content:space-between; margin:6px 0; }
    .label { color:var(--muted); font-size:13px; }
    .value { font-weight:600; }
    .total { font-size:22px; font-weight:800; }
    .warn { color: var(--warn); font-size:12px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:8px 6px; border-bottom:1px solid var(--border); }
    th { text-align:left; color:var(--muted); font-weight:600; }
    td.num, th.num { text-align:right; }
    footer { font-size:12px; color:var(--muted); text-align:center; padding:16px; }
    .asof { margin-left:auto; font-size:12px; color:var(--muted); }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <h1>Crypto Portfolio Tracker</h1>
      <span class="pill">Live</span>
      <div class="toolbar">
        <button id="refresh" class="primary">Refresh</button>
        <button id="auto">Auto: Off</button>
        <span class="asof" id="asof">—</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="cards">
      <div class="card">
        <div class="row"><div class="label">Total (USD via Binance)</div><div class="total" id="total_usd">$0.00</div></div>
        <div class="row"><div class="label">USD→INR (FX)</div><div class="value" id="fx_usdinr">—</div></div>
        <div class="row"><div class="label">Total (USD converted to INR)</div><div class="total" id="total_usd_in_inr">₹0.00</div></div>
        <div class="row"><div class="label">Status</div><div class="label" id="status_binance">OK</div></div>
      </div>
      <div class="card">
        <div class="row"><div class="label">Total (INR via WazirX)</div><div class="total" id="total_inr">₹0.00</div></div>
        <div class="row"><div class="label">USDT/INR (from WazirX)</div><div class="value" id="wazirx_usdtinr">—</div></div>
        <div class="row"><div class="label">Status</div><div class="label" id="status_wazirx">OK</div></div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Asset</th>
          <th class="num">Qty</th>
          <th class="num">Binance Price (USD)</th>
          <th class="num">Value (USD)</th>
          <th class="num">WazirX Price (INR)</th>
          <th class="num">Value (INR)</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <!-- Rows generated by JS -->
      </tbody>
    </table>

    <p class="warn" id="warnings"></p>
  </main>

  <footer>Binance spot ticker for USD, WazirX 24h ticker for INR, and a free USD→INR FX rate for conversion. Handles 429 with exponential backoff and skips failing sources.</footer>

<script>
const holdings = {
  BTC: 0.00157852,
  ETH: 0.50522559,
  USDT: 50.06,       // track zero if you don't hold; set to amount if you do
  DOGE: 256.471,       // update as needed
  WRX: 342.517,
  SHIB: 676437.91,       // e.g., 100000
  SXP: 6.97
};
const tracked = Object.keys(holdings);

const nfUSD = new Intl.NumberFormat(undefined, { style:'currency', currency:'USD' });
const nfINR = new Intl.NumberFormat(undefined, { style:'currency', currency:'INR' });

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

// Retry with backoff; honor Retry-After on 429; retry 5xx/network; no retry for other 4xx
async function fetchWithRetry(url, attempts = 3) {
  let lastErr;
  for (let i = 0; i < attempts; i++) {
    try {
      const res = await fetch(url, { cache:'no-store' });
      if (res.status === 429) {
        const retryAfter = parseInt(res.headers.get('Retry-After') || '0', 10);
        const delay = retryAfter > 0 ? retryAfter * 1000 : 300 * Math.pow(2, i);
        await sleep(delay);
        continue;
      }
      if (res.status >= 500) {
        await sleep(300 * Math.pow(2, i));
        continue;
      }
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    } catch (e) {
      lastErr = e;
      await sleep(300 * Math.pow(2, i));
    }
  }
  throw lastErr || new Error('Request failed');
}

// Build Binance symbols for USD pricing
function binanceSymbol(asset) {
  if (asset === 'USDT') return 'USDTUSDT'; // price 1
  return asset + 'USDT';
}

// Load Binance USD prices for tracked assets; WRX/SXP fallback handled outside per-asset if missing
async function loadBinanceUSD() {
  const prices = {};
  // Use bulk endpoint for efficiency when possible
  const symbolsParam = encodeURIComponent(JSON.stringify(tracked.map(binanceSymbol)));
  const url = `https://api.binance.com/api/v3/ticker/price?symbols=${symbolsParam}`;
  try {
    const data = await fetchWithRetry(url, 3);
    if (Array.isArray(data)) {
      data.forEach(item => { prices[item.symbol.replace('USDT','')] = parseFloat(item.price); });
    } else if (data && data.symbol && data.price) {
      prices[data.symbol.replace('USDT','')] = parseFloat(data.price);
    }
  } catch (e) {
    // If bulk fails, try individual essential ones
    for (const a of tracked) {
      try {
        const single = await fetchWithRetry(`https://api.binance.com/api/v3/ticker/price?symbol=${binanceSymbol(a)}`, 3);
        prices[a] = parseFloat(single.price);
      } catch {}
    }
  }
  // USDTUSDT should be 1 if not provided
  if (tracked.includes('USDT') && !prices.USDT) prices.USDT = 1;
  return prices;
}

// WazirX INR price map for tracked coins and USDTINR for conversion
async function loadWazirXINR() {
  const map = {};
  const tasks = [];
  for (const a of tracked) {
    const sym = (a.toLowerCase()) + 'inr';
    tasks.push(fetchWithRetry(`https://api.wazirx.com/sapi/v1/ticker/24hr?symbol=${sym}`, 3).then(j => ({ a, j })).catch(() => null));
  }
  // Always fetch USDTINR for FX derivation when needed
  const usdtINRPromise = fetchWithRetry(`https://api.wazirx.com/sapi/v1/ticker/24hr?symbol=usdtinr`, 3).then(j => j).catch(() => null);

  const results = await Promise.all(tasks);
  results.forEach(res => {
    if (res && res.j && res.j.lastPrice) {
      map[res.a] = parseFloat(res.j.lastPrice);
    }
  });
  const usdtINR = await usdtINRPromise;
  return { pricesINR: map, usdtINR: usdtINR && usdtINR.lastPrice ? parseFloat(usdtINR.lastPrice) : null };
}

// Simple USD→INR FX rate; if unavailable, falls back to WazirX USDTINR (treated as ≈ USDINR)
async function loadFxUSDINR() {
  // FreeForexAPI returns quotes like {"rates":{"USDINR":{ "rate": 83.1 }}, "code":200}
  try {
    const fx = await fetchWithRetry('https://www.freeforexapi.com/api/live?pairs=USDINR', 3);
    const rate = fx && fx.rates && fx.rates.USDINR && fx.rates.USDINR.rate;
    if (rate) return rate;
  } catch {}
  return null;
}

// Render table rows dynamically
function ensureRows() {
  const tbody = document.getElementById('tbody');
  if (tbody.childElementCount) return;
  tracked.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a}</td>
      <td class="num" id="${a}_qty">${holdings[a]}</td>
      <td class="num" id="${a}_px_usd">—</td>
      <td class="num" id="${a}_val_usd">—</td>
      <td class="num" id="${a}_px_inr">—</td>
      <td class="num" id="${a}_val_inr">—</td>
    `;
    tbody.appendChild(tr);
  });
}

async function refresh() {
  ensureRows();
  const asof = document.getElementById('asof');
  const warnings = document.getElementById('warnings');
  const statusBin = document.getElementById('status_binance');
  const statusWrx = document.getElementById('status_wazirx');
  warnings.textContent = '';
  statusBin.textContent = 'OK';
  statusWrx.textContent = 'OK';
  asof.textContent = 'Fetching...';

  // Reset totals
  document.getElementById('total_usd').textContent = '$0.00';
  document.getElementById('total_inr').textContent = '₹0.00';
  document.getElementById('total_usd_in_inr').textContent = '₹0.00';
  document.getElementById('wazirx_usdtinr').textContent = '—';
  document.getElementById('fx_usdinr').textContent = '—';

  let binUSD = null, wrxINR = null, fxUSDINR = null;

  await Promise.all([
    (async ()=>{
      try { binUSD = await loadBinanceUSD(); }
      catch(e){ statusBin.textContent = 'Unavailable'; warnings.textContent += `[Binance] ${e.message}. `; }
    })(),
    (async ()=>{
      try { wrxINR = await loadWazirXINR(); }
      catch(e){
        statusWrx.textContent = 'Unavailable';
        warnings.textContent += `[WazirX] ${e.message}. `;
        if ((e.message||'').includes('429')) warnings.textContent += `Rate limited; skipping WazirX for now. `;
      }
    })(),
    (async ()=>{
      try { fxUSDINR = await loadFxUSDINR(); }
      catch(e){ warnings.textContent += `[FX] ${e.message}. `; }
    })()
  ]);

  // Fill per-asset USD prices from Binance, with fallbacks from WazirX if Binance missing
  const usdPrices = {};
  if (binUSD) {
    tracked.forEach(a => { if (binUSD[a] != null) usdPrices[a] = binUSD[a]; });
  }
  // Fallbacks: if WRX/SXP/others missing on Binance, derive USD = INR / USDTINR
  if (wrxINR && wrxINR.pricesINR && wrxINR.usdtINR) {
    for (const a of tracked) {
      if (usdPrices[a] == null && wrxINR.pricesINR[a] != null && wrxINR.usdtINR) {
        usdPrices[a] = wrxINR.pricesINR[a] / wrxINR.usdtINR;
      }
    }
    document.getElementById('wazirx_usdtinr').textContent = wrxINR.usdtINR ? nfINR.format(wrxINR.usdtINR) : '—';
  }

  // Update FX
  const fxRate = fxUSDINR || (wrxINR && wrxINR.usdtINR) || null; // treat USDTINR as ≈ USDINR if needed
  if (fxRate) {
    document.getElementById('fx_usdinr').textContent = nfINR.format(fxRate);
  } else {
    document.getElementById('fx_usdinr').textContent = '—';
  }

  // Update per-asset rows
  let totalUSD = 0, totalINR = 0;
  for (const a of tracked) {
    const qty = holdings[a] || 0;
    // USD side
    const pxUSD = usdPrices[a];
    if (pxUSD != null) {
      const valUSD = pxUSD * qty;
      document.getElementById(`${a}_px_usd`).textContent = nfUSD.format(pxUSD);
      document.getElementById(`${a}_val_usd`).textContent = nfUSD.format(valUSD);
      totalUSD += valUSD;
    } else {
      document.getElementById(`${a}_px_usd`).textContent = '—';
      document.getElementById(`${a}_val_usd`).textContent = '—';
    }
    // INR side (direct from WazirX)
    const pxINR = wrxINR && wrxINR.pricesINR ? wrxINR.pricesINR[a] : null;
    if (pxINR != null) {
      const valINR = pxINR * qty;
      document.getElementById(`${a}_px_inr`).textContent = nfINR.format(pxINR);
      document.getElementById(`${a}_val_inr`).textContent = nfINR.format(valINR);
      totalINR += valINR;
    } else {
      document.getElementById(`${a}_px_inr`).textContent = '—';
      document.getElementById(`${a}_val_inr`).textContent = '—';
    }
  }

  // Totals
  document.getElementById('total_usd').textContent = nfUSD.format(totalUSD);
  document.getElementById('total_inr').textContent = totalINR ? nfINR.format(totalINR) : '—';
  document.getElementById('total_usd_in_inr').textContent = fxRate ? nfINR.format(totalUSD * fxRate) : '—';

  asof.textContent = new Date().toLocaleString();
}

document.getElementById('refresh').addEventListener('click', refresh);
let autoTimer = null;
document.getElementById('auto').addEventListener('click', (e)=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; e.target.textContent='Auto: Off'; }
  else { autoTimer=setInterval(refresh, 30000); e.target.textContent='Auto: 30s'; refresh(); }
});

// Initial rows and load
ensureRows();
refresh();
</script>
</body>
</html>
