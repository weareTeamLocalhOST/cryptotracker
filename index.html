<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Portfolio Tracker</title>
  <meta name="description" content="Tracks BTC, ETH, USDT, DOGE, WRX, SHIB, SXP with Binance USD and WazirX USDT prices, robust retries, and USD→INR conversion.">
  <style>
    :root { color-scheme: light dark; --bg:#0b0c0f; --fg:#e8e9ee; --card:#151821; --muted:#98a2b3; --accent:#3b82f6; --border:#212635; --warn:#f59e0b; }
    * { box-sizing:border-box }
    body { margin:0; font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--fg); }
    header { padding:16px; border-bottom:1px solid var(--border); position:sticky; top:0; backdrop-filter:saturate(160%) blur(6px); background: color-mix(in oklab, var(--bg) 85%, transparent); }
    h1 { margin:0; font-size:18px; }
    .container { max-width: 1040px; margin: 0 auto; padding: 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    button { background:#1b2030; color:var(--fg); border:1px solid var(--border); border-radius:8px; padding:8px 12px; font-size:14px; cursor:pointer; }
    button.primary { background: var(--accent); border-color: var(--accent); color:white; }
    .cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px,1fr)); gap:12px; margin-top:12px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px 16px; }
    .row { display:flex; align-items:center; justify-content:space-between; margin:6px 0; }
    .label { color:var(--muted); font-size:13px; }
    .value { font-weight:600; }
    .total { font-size:22px; font-weight:800; }
    .warn { color: var(--warn); font-size:12px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:8px 6px; border-bottom:1px solid var(--border); }
    th { text-align:left; color:var(--muted); font-weight:600; }
    td.num, th.num { text-align:right; }
    footer { font-size:12px; color:var(--muted); text-align:center; padding:16px; }
    .asof { margin-left:auto; font-size:12px; color:var(--muted); }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <h1>Crypto Portfolio Tracker</h1>
      <span class="pill">Live</span>
      <div class="toolbar">
        <button id="refresh" class="primary">Refresh</button>
        <button id="auto">Auto: Off</button>
        <span class="asof" id="asof">—</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="cards">
      <div class="card">
        <div class="row"><div class="label">Total (USD via Binance)</div><div class="total" id="total_usd_binance">$0.00</div></div>
        <div class="row"><div class="label">USD→INR (FX)</div><div class="value" id="fx_usdinr">—</div></div>
        <div class="row"><div class="label">Total (USD via Binance) in INR</div><div class="total" id="total_usd_in_inr">₹0.00</div></div>
        <div class="row"><div class="label">Status</div><div class="label" id="status_binance">OK</div></div>
      </div>
      <div class="card">
        <div class="row"><div class="label">Total (USD via WazirX USDT)</div><div class="total" id="total_usd_wazirx">$0.00</div></div>
        <div class="row"><div class="label">USDT ≈ USD</div><div class="value" id="wazirx_usdt_hint">1.00</div></div>
        <div class="row"><div class="label">Status</div><div class="label" id="status_wazirx">OK</div></div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Asset</th>
          <th class="num">Qty</th>
          <th class="num">Binance Price (USD)</th>
          <th class="num">Value (USD)</th>
          <th class="num">WazirX Price (USDT)</th>
          <th class="num">Value (USDT)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <p class="warn" id="warnings"></p>
  </main>

  <footer>Binance spot ticker (USD) and WazirX USDT market (USD-equivalent). Handles 429 with exponential backoff and skips failing sources.</footer>

<script>
const holdings = {
  BTC: 0.00157852,
  ETH: 0.50522559,
  USDT: 50.06,
  DOGE: 256.471,
  WRX: 342.517,
  SHIB: 676437.91,
  SXP: 6.97
};
const tracked = Object.keys(holdings);
const nfUSD = new Intl.NumberFormat(undefined, { style:'currency', currency:'USD' });
const nfINR = new Intl.NumberFormat(undefined, { style:'currency', currency:'INR' });

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
async function fetchWithRetry(url, attempts = 3) {
  let lastErr;
  for (let i = 0; i < attempts; i++) {
    try {
      const res = await fetch(url, { cache:'no-store' });
      if (res.status === 429) {
        const retryAfter = parseInt(res.headers.get('Retry-After') || '0', 10);
        const delay = retryAfter > 0 ? retryAfter * 1000 : 300 * Math.pow(2, i);
        await sleep(delay);
        continue;
      }
      if (res.status >= 500) { await sleep(300 * Math.pow(2, i)); continue; }
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    } catch (e) { lastErr = e; await sleep(300 * Math.pow(2, i)); }
  }
  throw lastErr || new Error('Request failed');
}

function binanceSymbol(a){ return a === 'USDT' ? 'USDTUSDT' : a + 'USDT'; }
function wazirxSymbolUSDT(a){ return a.toLowerCase() + 'usdt'; }

async function loadBinanceUSD() {
  const prices = {};
  const symbolsParam = encodeURIComponent(JSON.stringify(tracked.map(binanceSymbol)));
  const url = `https://api.binance.com/api/v3/ticker/price?symbols=${symbolsParam}`;
  try {
    const data = await fetchWithRetry(url, 3);
    if (Array.isArray(data)) data.forEach(it => prices[it.symbol.replace('USDT','')] = parseFloat(it.price));
    else if (data && data.symbol) prices[data.symbol.replace('USDT','')] = parseFloat(data.price);
  } catch {
    for (const a of tracked) {
      try {
        const single = await fetchWithRetry(`https://api.binance.com/api/v3/ticker/price?symbol=${binanceSymbol(a)}`, 3);
        prices[a] = parseFloat(single.price);
      } catch {}
    }
  }
  if (tracked.includes('USDT') && !prices.USDT) prices.USDT = 1;
  return prices;
}

async function loadWazirXUSDT() {
  const prices = {};
  const tasks = tracked.map(a =>
    fetchWithRetry(`https://api.wazirx.com/sapi/v1/ticker/24hr?symbol=${wazirxSymbolUSDT(a)}`, 3)
      .then(j => ({ a, j })).catch(() => null)
  );
  const res = await Promise.all(tasks);
  res.forEach(r => {
    if (!r) return;
    if (r.a === 'USDT') { prices.USDT = 1; return; }
    if (r.j && (r.j.lastPrice || r.j.last)) {
      const lp = r.j.lastPrice || r.j.last;
      const num = parseFloat(lp);
      if (!Number.isNaN(num)) prices[r.a] = num;
    }
  });
  if (tracked.includes('USDT') && !prices.USDT) prices.USDT = 1;
  return prices;
}

async function loadFxUSDINR() {
  try {
    const fx = await fetchWithRetry('https://www.freeforexapi.com/api/live?pairs=USDINR', 3);
    const rate = fx && fx.rates && fx.rates.USDINR && fx.rates.USDINR.rate;
    if (rate) return rate;
  } catch {}
  return null;
}

function ensureRows() {
  const tbody = document.getElementById('tbody');
  if (tbody.childElementCount) return;
  tracked.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a}</td>
      <td class="num" id="${a}_qty">${holdings[a]}</td>
      <td class="num" id="${a}_px_usd_bin">—</td>
      <td class="num" id="${a}_val_usd_bin">—</td>
      <td class="num" id="${a}_px_usd_wrx">—</td>
      <td class="num" id="${a}_val_usd_wrx">—</td>
    `;
    tbody.appendChild(tr);
  });
}

async function refresh() {
  ensureRows();
  const asof = document.getElementById('asof');
  const warnings = document.getElementById('warnings');
  const statusBin = document.getElementById('status_binance');
  const statusWrx = document.getElementById('status_wazirx');
  warnings.textContent = '';
  statusBin.textContent = 'OK';
  statusWrx.textContent = 'OK';
  asof.textContent = 'Fetching...';

  let binUSD = null, wrxUSDT = null, fxUSDINR = null;

  await Promise.all([
    (async ()=>{ try { binUSD = await loadBinanceUSD(); } catch(e){ statusBin.textContent='Unavailable'; warnings.textContent += `[Binance] ${e.message}. `; } })(),
    (async ()=>{ try { wrxUSDT = await loadWazirXUSDT(); } catch(e){ statusWrx.textContent='Unavailable'; warnings.textContent += `[WazirX] ${e.message}. `; if((e.message||'').includes('429')) warnings.textContent += `Rate limited; skipping WazirX USDT. `; } })(),
    (async ()=>{ try { fxUSDINR = await loadFxUSDINR(); if (fxUSDINR) document.getElementById('fx_usdinr').textContent = nfINR.format(fxUSDINR); } catch(e){ warnings.textContent += `[FX] ${e.message}. `; } })()
  ]);

  let totalBinUSD = 0, totalWrxUSD = 0;

  for (const a of tracked) {
    const q = holdings[a] || 0;

    const pxBin = binUSD && binUSD[a] != null ? binUSD[a] : null;
    if (pxBin != null) {
      const val = pxBin * q;
      document.getElementById(`${a}_px_usd_bin`).textContent = nfUSD.format(pxBin);
      document.getElementById(`${a}_val_usd_bin`).textContent = nfUSD.format(val);
      totalBinUSD += val;
    } else {
      document.getElementById(`${a}_px_usd_bin`).textContent = '—';
      document.getElementById(`${a}_val_usd_bin`).textContent = '—';
    }

    const pxWrx = wrxUSDT && wrxUSDT[a] != null ? wrxUSDT[a] : null;
    if (pxWrx != null) {
      const val = pxWrx * q;
      document.getElementById(`${a}_px_usd_wrx`).textContent = nfUSD.format(pxWrx);
      document.getElementById(`${a}_val_usd_wrx`).textContent = nfUSD.format(val);
      totalWrxUSD += val;
    } else {
      document.getElementById(`${a}_px_usd_wrx`).textContent = '—';
      document.getElementById(`${a}_val_usd_wrx`).textContent = '—';
    }
  }

  document.getElementById('total_usd_binance').textContent = nfUSD.format(totalBinUSD);
  document.getElementById('total_usd_wazirx').textContent = totalWrxUSD ? nfUSD.format(totalWrxUSD) : '—';
  document.getElementById('total_usd_in_inr').textContent = fxUSDINR ? nfINR.format(totalBinUSD * fxUSDINR) : '—';

  asof.textContent = new Date().toLocaleString();
}

document.getElementById('refresh').addEventListener('click', refresh);
let autoTimer = null;
document.getElementById('auto').addEventListener('click', (e)=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; e.target.textContent='Auto: Off'; }
  else { autoTimer=setInterval(refresh, 30000); e.target.textContent='Auto: 30s'; refresh(); }
});

refresh();
</script>
</body>
</html>
