<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Portfolio Tracker</title>
  <style>
    :root { color-scheme: light dark; --bg:#0b0c0f; --fg:#e8e9ee; --card:#151821; --muted:#98a2b3; --accent:#3b82f6; --border:#212635; --warn:#f59e0b; }
    * { box-sizing:border-box }
    body { margin:0; font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--fg); }
    header { padding:16px; border-bottom:1px solid var(--border); position:sticky; top:0; backdrop-filter:saturate(160%) blur(6px); background: color-mix(in oklab, var(--bg) 85%, transparent); }
    h1 { margin:0; font-size:18px; }
    .container { max-width: 980px; margin: 0 auto; padding: 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    button { background:#1b2030; color:var(--fg); border:1px solid var(--border); border-radius:8px; padding:8px 12px; font-size:14px; cursor:pointer; }
    button.primary { background: var(--accent); border-color: var(--accent); color:white; }
    .cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:12px; margin-top:12px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px 16px; }
    .row { display:flex; align-items:center; justify-content:space-between; margin:6px 0; }
    .label { color:var(--muted); font-size:13px; }
    .value { font-weight:600; }
    .total { font-size:22px; font-weight:800; }
    .warn { color: var(--warn); font-size:12px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:10px 8px; border-bottom:1px solid var(--border); }
    th { text-align:left; color:var(--muted); font-weight:600; }
    td.num, th.num { text-align:right; }
    footer { font-size:12px; color:var(--muted); text-align:center; padding:16px; }
    .asof { margin-left:auto; font-size:12px; color:var(--muted); }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <h1>Crypto Portfolio Tracker</h1>
      <span class="pill">Live</span>
      <div class="toolbar">
        <button id="refresh" class="primary">Refresh</button>
        <button id="auto">Auto: Off</button>
        <span class="asof" id="asof">—</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="cards">
      <div class="card">
        <div class="row"><div class="label">Total (USD from Binance)</div><div class="total" id="total_usd">$0.00</div></div>
        <div class="row"><div class="label">BTC 0.000005 · ETH 0.25 · WRX 23</div><div class="label" id="status_binance">OK</div></div>
      </div>
      <div class="card">
        <div class="row"><div class="label">Total (INR from WazirX)</div><div class="total" id="total_inr">₹0.00</div></div>
        <div class="row"><div class="label">Locally computed</div><div class="label" id="status_wazirx">OK</div></div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Asset</th>
          <th class="num">Qty</th>
          <th class="num">Binance Price (USD)</th>
          <th class="num">Value (USD)</th>
          <th class="num">WazirX Price (INR)</th>
          <th class="num">Value (INR)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>BTC</td>
          <td class="num">0.000005</td>
          <td class="num" id="btc_px_usd">—</td>
          <td class="num" id="btc_val_usd">—</td>
          <td class="num" id="btc_px_inr">—</td>
          <td class="num" id="btc_val_inr">—</td>
        </tr>
        <tr>
          <td>ETH</td>
          <td class="num">0.25</td>
          <td class="num" id="eth_px_usd">—</td>
          <td class="num" id="eth_val_usd">—</td>
          <td class="num" id="eth_px_inr">—</td>
          <td class="num" id="eth_val_inr">—</td>
        </tr>
        <tr>
          <td>WRX</td>
          <td class="num">23</td>
          <td class="num" id="wrx_px_usd">—</td>
          <td class="num" id="wrx_val_usd">—</td>
          <td class="num" id="wrx_px_inr">—</td>
          <td class="num" id="wrx_val_inr">—</td>
        </tr>
      </tbody>
    </table>

    <p class="warn" id="warnings"></p>
  </main>

  <footer>Handles 429 with backoff and skips failing sources. Data: Binance price ticker and WazirX 24h ticker. </footer>

<script>
const qty = { BTC: 0.000005, ETH: 0.25, WRX: 23 };
const nfUSD = new Intl.NumberFormat(undefined, { style:'currency', currency:'USD' });
const nfINR = new Intl.NumberFormat(undefined, { style:'currency', currency:'INR' });

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

// Retry on 429/5xx, honor Retry-After, cap attempts
async function fetchWithRetry(url, opts = {}, attempts = 3) {
  let lastErr;
  for (let i = 0; i < attempts; i++) {
    try {
      const res = await fetch(url, { cache:'no-store', ...opts });
      if (res.status === 429) {
        const retryAfter = parseInt(res.headers.get('Retry-After') || '0', 10);
        const delay = retryAfter > 0 ? (retryAfter * 1000) : (200 * Math.pow(2, i));
        await sleep(delay);
        continue;
      }
      if (res.status >= 500 && res.status < 600) {
        await sleep(200 * Math.pow(2, i));
        continue;
      }
      if (!res.ok) {
        // Non-retryable 4xx
        throw new Error(`${res.status} ${res.statusText}`);
      }
      return await res.json();
    } catch (err) {
      lastErr = err;
      // Network error; retry with backoff
      await sleep(200 * Math.pow(2, i));
    }
  }
  throw lastErr || new Error('Request failed');
}

// Binance USD prices; WRX via WRXUSDT if available, else derive from WazirX INR/USDTINR
async function loadBinanceUSD() {
  const [btc, eth] = await Promise.all([
    fetchWithRetry('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT'),
    fetchWithRetry('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT'),
  ]);
  let wrxUSD;
  try {
    const wrx = await fetchWithRetry('https://api.binance.com/api/v3/ticker/price?symbol=WRXUSDT');
    wrxUSD = parseFloat(wrx.price);
  } catch {
    const [wrxINR, usdtINR] = await Promise.all([
      fetchWithRetry('https://api.wazirx.com/sapi/v1/ticker/24hr?symbol=wrxinr'),
      fetchWithRetry('https://api.wazirx.com/sapi/v1/ticker/24hr?symbol=usdtinr'),
    ]);
    wrxUSD = parseFloat(wrxINR.lastPrice) / parseFloat(usdtINR.lastPrice);
  }
  return {
    BTC: parseFloat(btc.price),
    ETH: parseFloat(eth.price),
    WRX: wrxUSD
  };
}

// WazirX INR prices with retry/backoff; if fails, caller will skip INR block
async function loadWazirXINR() {
  const [btc, eth, wrx] = await Promise.all([
    fetchWithRetry('https://api.wazirx.com/sapi/v1/ticker/24hr?symbol=btcinr'),
    fetchWithRetry('https://api.wazirx.com/sapi/v1/ticker/24hr?symbol=ethinr'),
    fetchWithRetry('https://api.wazirx.com/sapi/v1/ticker/24hr?symbol=wrxinr'),
  ]);
  return {
    BTC: parseFloat(btc.lastPrice),
    ETH: parseFloat(eth.lastPrice),
    WRX: parseFloat(wrx.lastPrice)
  };
}

async function refresh() {
  const asof = document.getElementById('asof');
  const warnings = document.getElementById('warnings');
  const statusBin = document.getElementById('status_binance');
  const statusWrx = document.getElementById('status_wazirx');
  warnings.textContent = '';
  statusBin.textContent = 'OK';
  statusWrx.textContent = 'OK';
  asof.textContent = 'Fetching...';

  // Reset cells
  const ids = ['btc_px_usd','eth_px_usd','wrx_px_usd','btc_val_usd','eth_val_usd','wrx_val_usd',
               'btc_px_inr','eth_px_inr','wrx_px_inr','btc_val_inr','eth_val_inr','wrx_val_inr'];
  ids.forEach(id => document.getElementById(id).textContent = '—');

  let pxUSD = null, pxINR = null;
  // Load both sources independently with guarded errors
  try {
    pxUSD = await loadBinanceUSD();
  } catch (e) {
    statusBin.textContent = `Unavailable`;
    warnings.textContent += `[Binance] ${e.message}. `;
  }

  try {
    pxINR = await loadWazirXINR();
  } catch (e) {
    statusWrx.textContent = `Unavailable`;
    warnings.textContent += `[WazirX] ${e.message}. `;
    // If the message included 429, hint to slow down
    if ((e.message||'').includes('429')) {
      warnings.textContent += `Rate limited; backing off as per Retry-After headers. `;
    }
  }

  // Update USD side if available
  if (pxUSD) {
    const usdVals = {
      BTC: pxUSD.BTC * qty.BTC,
      ETH: pxUSD.ETH * qty.ETH,
      WRX: pxUSD.WRX * qty.WRX
    };
    document.getElementById('btc_px_usd').textContent = nfUSD.format(pxUSD.BTC);
    document.getElementById('eth_px_usd').textContent = nfUSD.format(pxUSD.ETH);
    document.getElementById('wrx_px_usd').textContent = nfUSD.format(pxUSD.WRX);
    document.getElementById('btc_val_usd').textContent = nfUSD.format(usdVals.BTC);
    document.getElementById('eth_val_usd').textContent = nfUSD.format(usdVals.ETH);
    document.getElementById('wrx_val_usd').textContent = nfUSD.format(usdVals.WRX);
    const totalUSD = usdVals.BTC + usdVals.ETH + usdVals.WRX;
    document.getElementById('total_usd').textContent = nfUSD.format(totalUSD);
  } else {
    document.getElementById('total_usd').textContent = '—';
  }

  // Update INR side if available
  if (pxINR) {
    const inrVals = {
      BTC: pxINR.BTC * qty.BTC,
      ETH: pxINR.ETH * qty.ETH,
      WRX: pxINR.WRX * qty.WRX
    };
    document.getElementById('btc_px_inr').textContent = nfINR.format(pxINR.BTC);
    document.getElementById('eth_px_inr').textContent = nfINR.format(pxINR.ETH);
    document.getElementById('wrx_px_inr').textContent = nfINR.format(pxINR.WRX);
    document.getElementById('btc_val_inr').textContent = nfINR.format(inrVals.BTC);
    document.getElementById('eth_val_inr').textContent = nfINR.format(inrVals.ETH);
    document.getElementById('wrx_val_inr').textContent = nfINR.format(inrVals.WRX);
    const totalINR = inrVals.BTC + inrVals.ETH + inrVals.WRX;
    document.getElementById('total_inr').textContent = nfINR.format(totalINR);
  } else {
    document.getElementById('total_inr').textContent = '—';
  }

  asof.textContent = new Date().toLocaleString();
}

document.getElementById('refresh').addEventListener('click', refresh);
let autoTimer = null;
document.getElementById('auto').addEventListener('click', (e)=>{
  if(autoTimer){
    clearInterval(autoTimer);
    autoTimer = null;
    e.target.textContent = 'Auto: Off';
  } else {
    // Slow down to be kind to public APIs; align with rate-limit guidance
    autoTimer = setInterval(refresh, 30000);
    e.target.textContent = 'Auto: 30s';
    refresh();
  }
});

refresh();
</script>
</body>
</html>
